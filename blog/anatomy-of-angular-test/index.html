<html><head><title>An AngularJS test | Dave Woodall</title><meta charset=utf-8 /><link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css" rel=stylesheet /><script src="../../scripts/lib/lodash.min.js"></script><script src="../../scripts/lib/jquery.min.js"></script><script src="../../scripts/lib/modernizer.js"></script><script src="../../scripts/script.js"></script><meta content="initial-scale=1.0" name=viewport /><meta content="An AngularJS test" property="og:title"/><meta content="Dave Woodall" property="og:site_name"/><meta content="http://wwwoodall.com" property="og:url"/><meta content=summary_large_image name="twitter:card"/><meta content="@wwwoodall" name="twitter:site"/><meta content="@wwwoodall" name="twitter:creator"/><meta content="Terms when first learning to test Angular." property="og:description"/><meta content="Terms when first learning to test Angular." name="twitter:description"/></head><link href="../../stylesheets/application.css" media=screen rel=stylesheet /><body><div class=l-header><nav class=left-nav><div class=bio-pic><img src="../../images/dave_woodall.jpg"/></div><p><a href="/about-dave">Dave Woodall</a></p><div class=bio>Christian, Husband, Dad, Developer, Designer, Drawer, Inventor, INTJ, Reader, Writer, French press Snowboard then beers.</div><div class=location>Boulder, CO</div><ul><li><a class="" href="/feed/">feed</a></li><li><a class="" href="/jots/">jots</a></li><li><a class="" href="/gifs/">gifs</a></li><li><a class="" href="/pictures/">pictures</a></li><li><a class="" href="/watching/">watching</a></li><li><a class=" active" href="/blog/">blog</a></li><li><a class="" href="/questions/">questions</a></li><li><a class="" href="/notes/">notes</a></li><li><a class="" href="/reading/">reading</a></li><li><a class="" href="/links/">links</a></li></ul></nav></div><div class=l-container><article class=type-system-traditional><p class=type><a href="/blog">all posts</a> >> <a href="/learning-to-code">Learning to Code</a></p><h1>An AngularJS test</h1><p class=date>Oct 20, 2014</p><p>After writing Angular you'll soon want to test it. In learning to test you'll encounter a second layer of terms and functionality about Angular. I had to learn some new concepts and they made my head spin. So, I am documenting here for a reminder of the parts that are necessary to test. </p> <p>Now that I've written a few tests, I see why and how it works and it's not that bad :-) </p> <p>I'm going to breakdown a test file step by step as I understand it. <a href="#test-without-comments">Scroll to the bottom</a> if you want to see the overview before reading the steps</p> <h5 id=step-1-require>Step 1: require</h5> <p>The first thing is you need to require all the files you need. Which will be your angular code, angular_mocks, and your code.</p> <pre class="highlight coffeescript"><code><span class="c1">#= require libraries/angular
#= require plugins/recommendations
#= require helpers/specHelper
#= require helpers/angular_mocks
#= require mocks/recommendations_mocks
</span></code></pre> <h5 id=step-2>Step 2.</h5> <p>Create a describe block that will wrap your suite.</p> <pre class="highlight coffeescript"><code><span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
</code></pre> <h5 id=step-3>Step 3.</h5> <p>Javascript manages scope through functions, (functional scope). Each test will be it's own scope so we need to put variables at the parent scope so that the children will have access to them.</p> <pre class="highlight coffeescript"><code>    <span class="nx">$injector</span>           <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="no">undefined</span>
</code></pre> <h5 id=step-4>Step 4.</h5> <p>Angular will only load the modules you explicitly call.</p> <pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="nx">module</span><span class="p">(</span><span class="s">"RecommendationMocks"</span><span class="p">,</span> <span class="s">"recommendationsApp"</span><span class="p">)</span>
</code></pre> <h5 id=step-5>Step 5.</h5> <p>Angular is brokend into services. These services are not loaded until you tell them to be. You have to inject the injector, then use this injector.get() syntax</p> <pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="nx">inject</span> <span class="p">(</span><span class="nx">_$injector_</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">$injector</span>           <span class="o">=</span> <span class="nx">_$injector_</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$compile'</span><span class="p">)</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$rootScope'</span><span class="p">)</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$new</span><span class="p">()</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'recommendationsModel'</span><span class="p">)</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"mockRecommendations"</span><span class="p">)</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$httpBackend'</span><span class="p">)</span>
</code></pre> <h4 id=testing-a-service>Testing a Service</h4> <p>A service will use the HTTP to get a template, or other data.</p> <h5 id=step-6>Step 6.</h5> <p>If your service makes an HTTP request, you want need to stub it out in a before each and show that you are expecting to make the call. The call will not actually be made though because <code>$httpBackend</code> will stub it out.</p> <pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
     <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">expectGET</span><span class="p">(</span><span class="s">"/browse/p.json"</span><span class="p">).</span><span class="na">respond</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">angular</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="nx">mockRecommendations</span><span class="p">))</span>
</code></pre> <h5 id=step-7>Step 7.</h5> <p>You then have to have an aftereacth that you didn't make more HTTP calls than expected. And that the HTTP requests resolve as expected.</p> <pre class="highlight coffeescript"><code>  <span class="nx">afterEach</span> <span class="o">-&gt;</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingExpectation</span><span class="p">()</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingRequest</span><span class="p">()</span>
</code></pre> <h5 id=step-8>Step 8.</h5> <p>The below .fetch() method is my custom code. But after you make that call, you need to flush() which connects the fetch() call with the HTTP call that the <code>fetch()</code> makes.</p> <pre class="highlight coffeescript"><code>  <span class="nx">describe</span> <span class="s">"Model: recommendationsModel"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">describe</span> <span class="s">"fetch()"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">it</span> <span class="s">"makes a GET request for recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">recommendations</span><span class="p">.</span><span class="na">fetch</span><span class="p">()</span>
        <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
</code></pre> <h4 id=testing-a-directive>Testing a directive</h4> <p>A directive will be added to the html so you need to create a before each to add some html the page;</p> <h5 id=step-9>Step 9.</h5> <p>Use Jquery to add some HTML to the page</p> <pre class="highlight coffeescript"><code>  <span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">append</span><span class="p">(</span><span class="s">"
        &lt;div id='wrapper'&gt;
          &lt;p id='foo'&gt;remove me.&lt;/p&gt;
        &lt;/div&gt;
        "</span><span class="p">)</span>

    <span class="nx">afterEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">"#wrapper"</span><span class="p">).</span><span class="na">remove</span><span class="p">()</span>
</code></pre> <h5 id=step-10>Step 10.</h5> <p>Notice we are using <code>$compile</code> this service will convert the template and expressions into html. </p> <pre class="highlight coffeescript"><code>    <span class="nx">it</span> <span class="s">"returns personalized recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="s">"
        &lt;recommendations selector='#foo'&gt;
          &lt;div ng-repeat='deal in deals'&gt;{{ deal.title }}&lt;/div&gt;
        &lt;/recommendations&gt;
      "</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="na">$apply</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Go-karting'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Sushi'</span>
</code></pre> <h5 id=step-11>Step 11.</h5> <p>Here, we use <code>$compile</code> to convert our directive into html. Then, <code>$digest</code> attacheses it to the root scope. You have to do this.</p> <pre class="highlight coffeescript"><code>    <span class="nx">it</span> <span class="s">'replaces an a existing element identified by selector attribute'</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">$compile</span><span class="p">(</span><span class="s">"&lt;recommendations selector='#foo'&gt;&lt;/recommendations&gt;"</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$digest</span><span class="p">()</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">html</span><span class="p">()).</span><span class="na">not</span><span class="p">.</span><span class="na">toContain</span> <span class="s">'remove me.'</span>
</code></pre> <div id=test-without-comments></div> <h3 id=code-without-comments>Code without comments</h3> <pre class="highlight coffeescript"><code><span class="c1">#= require libraries/angular
#= require plugins/recommendations
#= require helpers/specHelper
#= require helpers/angular_mocks
#= require mocks/recommendations_mocks
</span>
<span class="nx">describe</span> <span class="s">"Recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$injector</span>           <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">recommendations</span>     <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$compile</span>            <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$scope</span>              <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="no">undefined</span>

  <span class="nx">beforeEach</span> <span class="nx">module</span><span class="p">(</span><span class="s">"RecommendationMocks"</span><span class="p">,</span> <span class="s">"app.recommendations"</span><span class="p">)</span>

  <span class="nx">beforeEach</span> <span class="nx">inject</span> <span class="p">(</span><span class="nx">_$injector_</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">$injector</span>           <span class="o">=</span> <span class="nx">_$injector_</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$compile'</span><span class="p">)</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$rootScope'</span><span class="p">)</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$new</span><span class="p">()</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'recommendationsModel'</span><span class="p">)</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"mockRecommendations"</span><span class="p">)</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$httpBackend'</span><span class="p">)</span>

  <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
     <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">expectGET</span><span class="p">(</span><span class="s">"/browse/p.json"</span><span class="p">).</span><span class="na">respond</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">angular</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="nx">mockRecommendations</span><span class="p">))</span>

  <span class="nx">afterEach</span> <span class="o">-&gt;</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingExpectation</span><span class="p">()</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingRequest</span><span class="p">()</span>

  <span class="nx">describe</span> <span class="s">"Model: recommendationsModel"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">describe</span> <span class="s">"fetch()"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">it</span> <span class="s">"makes a GET request for recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">recommendations</span><span class="p">.</span><span class="na">fetch</span><span class="p">()</span>
        <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>

  <span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">append</span><span class="p">(</span><span class="s">"
        &lt;div id='wrapper'&gt;
          &lt;p id='foo'&gt;remove me.&lt;/p&gt;
        &lt;/div&gt;
        "</span><span class="p">)</span>

    <span class="nx">afterEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">"#wrapper"</span><span class="p">).</span><span class="na">remove</span><span class="p">()</span>

    <span class="nx">it</span> <span class="s">"returns personalized recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="s">"
        &lt;recommendations selector='#foo'&gt;
          &lt;div ng-repeat='deal in deals'&gt;{{ deal.title }}&lt;/div&gt;
        &lt;/recommendations&gt;
      "</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="na">$apply</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Go-karting'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Sushi'</span>

    <span class="nx">it</span> <span class="s">'replaces an a existing element identified by selector attribute'</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">$compile</span><span class="p">(</span><span class="s">"&lt;recommendations selector='#foo'&gt;&lt;/recommendations&gt;"</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$digest</span><span class="p">()</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">html</span><span class="p">()).</span><span class="na">not</span><span class="p">.</span><span class="na">toContain</span> <span class="s">'remove me.'</span>
</code></pre> <div id=disqus_thread></div><script>var disqus_shortname = 'wwwoodall';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></script><hr/><div class=intro-text><h2>More from</h2><h3>Learning to Code</h3></div><h2><a href="/blog/play-cover-songs-first/">play cover songs first</a></h2><p><p>There are tons of tutorial sites out there. My favorite front-end one is <a href="//www.codrops.com" target=_blank>CoDrops</a> because of the amazing content and how well it's organized.</p> <p>That site has tons of tutorials and I wonder how they do it. It got me thinking of a progress path I want...</p></p><h2><a href="/blog/managing-state/">Managing state</a></h2><p><p>The web is by nature a stateless environment. Meaning, when you hit refresh on the page, things go away. That is unless state has been added. </p> <p>There are four ways to add state;</p> <h3 id=cookies--sessions>Cookies / Sessions</h3> <p>Stored in memory by apps.</p> <h3 id=local-storage>Local Storage</h3> <p>Stored...</p></p><h2><a href="/blog/web-part-of-web-app/">The 'web' part of a web application</a></h2><p><p>If you write rails then you've heard the phrase <em>Fat Models. Skinny Controllers</em>. The notion of a skinny controller and other comments describing the lack of code in a controller made me wonder if a Controller is a second class citizen. </p> <p>I've heard...</p></p></article></div></body><footer class=footer><div class=footer-links><ul><li><h4><a href="/">wwwoodall</a></h4></li><li>by Dave Woodall</li><li>Boulder, CO</li><li><h3 class="fa fa-phone"> Contact</h3></li><li><a class="fa fa-envelope-o" href="mailto:dave@woodalls.me"> email</a></li><li><a target=_blank href="//www.github.com/woodall"><div class="fa fa-github"></div> <span>github</span></a></li><li><a target=_blank href="//www.dribbble.com/wwwoodall"><div class="fa fa-dribbble"></div> <span>dribbble</span></a></li></ul><ul><li><h3 class="fa fa-wrench"> work</h3></li><li><a href="/summary">summary</a></li></ul><ul><li><h3 class="fa fa-paper-plane"> fun</h3></li><ul><li><a class="" href="/feed/">feed</a></li><li><a class="" href="/jots/">jots</a></li><li><a class="" href="/gifs/">gifs</a></li><li><a class="" href="/pictures/">pictures</a></li><li><a class="" href="/watching/">watching</a></li><li><a class=" active" href="/blog/">blog</a></li><li><a class="" href="/questions/">questions</a></li><li><a class="" href="/notes/">notes</a></li><li><a class="" href="/reading/">reading</a></li><li><a class="" href="/links/">links</a></li></ul></ul><ul><li><h3 class="fa fa-flask"> apps</h3></li><li><a class="" href="/tld-color-and-emoji-guide/">TLD color guide</a></li><li><a href="//hashpage.wwwoodall.com">hash page</a></li></ul></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-52536027-1', 'auto');
ga('send', 'pageview');</script></html>