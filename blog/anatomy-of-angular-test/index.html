<html><head><title>An AngularJS test | Dave Woodall</title><meta charset="utf-8" /><link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" /><script src="../../scripts/lib/jquery.min-7e1c143b.js" type="text/javascript"></script><script src="../../scripts/lib/modernizer-b2be4ef8.js" type="text/javascript"></script><script src="../../scripts/nav_overlay-747321c6.js" type="text/javascript"></script><script src="../../scripts/script-e7c3a842.js" type="text/javascript"></script><meta content="initial-scale=1.0" name="viewport" /><meta content="An AngularJS test" property="og:title" /><meta content="Dave Woodall" property="og:site_name" /><meta content="http://wwwoodall.com" property="og:url" /><meta content="http://wwwoodall.com/images/pictures/hero.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@wwwoodall" name="twitter:site" /><meta content="@wwwoodall" name="twitter:creator" /><meta content="" property="og:description" /></head><link href="../../stylesheets/application-cf65f318.css" media="screen" rel="stylesheet" type="text/css" /><link href="http://fonts.googleapis.com/css?family=Radley:400,400italic" rel="stylesheet" type="text/css" /><link href="http://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic" rel="stylesheet" type="text/css" /><body><div class="l-header"><nav class="left-nav"><div class="pic"><img src="../../images/dave_woodall-4a4784bb.jpg" /></div><p>Dave Woodall</p><div class="bio">Christian, Husband, Dad, Hacker, Designer, Inventor, Thinker, Reader, Writer, French press Snowboard then beers.</div><div class="location">Boulder, CO</div><ul><li><a href="/"><div class="fa fa-home"></div></a></li><li><a class="" href="/gifs/">gifs</a></li><li><a class="" href="/pictures/">pictures</a></li><li><a class="" href="/jots/">jots</a></li><li><a class="" href="/blog/">blog</a></li><li><a class="" href="/shortcuts/">shortcuts</a></li><li><a class="" href="/notes/">notes</a></li><li><a class="" href="/reading/">reading</a></li><li><a class="" href="/links/">links</a></li></ul><div class="mailchimp"><!--Begin MailChimp Signup Form--><link href="//cdn-images.mailchimp.com/embedcode/classic-081711.css" rel="stylesheet" type="text/css"><style type="text/css">#mc_embed_signup background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;
/!* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */</style><div id="mc_embed_signup"><form action="//lettucebooks.us8.list-manage.com/subscribe/post?u=42150f382a237947f46c88221&amp;id=49f1ff76a7" class="validate" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form" novalidate="" target="_blank"><div id="mc_embed_signup_scroll"><div class="mc-field-group"><label for="mce-EMAIL">Stay updated!</label><input class="required email" id="mce-EMAIL" name="EMAIL" type="email" value="email address" /></div><div class="clear" id="mce-responses"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div><!--real people should not fill this in and expect good things - do not remove this or risk form bot signups--><div style="position: absolute; left: -5000px;"><input name="b_42150f382a237947f46c88221_49f1ff76a7" tabindex="-1" type="text" value="" /></div><div class="clear"><input class="button" id="mc-embedded-subscribe" name="subscribe" type="submit" value="Subscribe" /></div></div></form></div><script src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js" type="text/javascript"></script><script type="text/javascript">| (function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);  / End mc_embed_signup</script></link></div></nav></div><div class="l-container"><article class="type-system-traditional"><p class="type">angular</p><h1>An AngularJS test</h1><img src="../../images/pictures/hero-8a0afb6d.png" /><cite>Camping on Father's Day 2014</cite><h2>Terms when first learning to test Angular.</h2><p class="date">Oct 20, 2014</p><p>After writing Angular you'll soon want to test it. Testing is when you'll encounter a second layer of terms and functionality that was designed. I had to learn some new concepts and they made my head spin. So, I am documenting here for a reminder of the parts that are necessary to test. </p>

<p>Now that I've written a few tests, I see why and how it works and it's not that bad :-)</p>

<h5 id="step-1-require">Step 1: require</h5>
<p>The first thing is you need to require all the files you need.
Which will be your angular code, angular_mocks, and your code.</p>

<pre class="highlight coffeescript"><code><span class="c1">#= require libraries/angular
#= require plugins/recommendations
#= require helpers/specHelper
#= require helpers/angular_mocks
#= require mocks/recommendations_mocks
</span></code></pre>

<h5 id="step-2">Step 2.</h5>
<p>Create a describe block that will wrap your suite.</p>

<pre class="highlight coffeescript"><code><span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
</code></pre>

<h5 id="step-3">Step 3.</h5>
<p>Javascript manages scope through functions, (functional scope). Each test will be it's own scope so we need to put variables at the parent scope so that the children will have access to them.</p>

<pre class="highlight coffeescript"><code>    <span class="nx">$injector</span>           <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="no">undefined</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="no">undefined</span>
</code></pre>

<h5 id="step-4">Step 4.</h5>
<p>Angular will only load the modules you explicitly call.</p>

<pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="nx">module</span><span class="p">(</span><span class="s">"RecommendationMocks"</span><span class="p">,</span> <span class="s">"recommendationsApp"</span><span class="p">)</span>
</code></pre>

<h5 id="step-5">Step 5.</h5>
<p>Angular is brokend into services. These services are not loaded until you tell them to be. You have to inject the injector, then use this injector.get() syntax</p>

<pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="nx">inject</span> <span class="p">(</span><span class="nx">_$injector_</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">$injector</span>           <span class="o">=</span> <span class="nx">_$injector_</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$compile'</span><span class="p">)</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$rootScope'</span><span class="p">)</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$new</span><span class="p">()</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'recommendationsModel'</span><span class="p">)</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"mockRecommendations"</span><span class="p">)</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$httpBackend'</span><span class="p">)</span>
</code></pre>

<h4 id="testing-a-service">Testing a Service</h4>
<p>A service will use the HTTP to get a template, or other data.</p>

<h5 id="step-6">Step 6.</h5>
<p>If your service makes an HTTP request, you want need to stub it out in a before each and show that you are expecting to make the call. The call will not actually be made though because <code>$httpBackend</code> will stub it out.</p>

<pre class="highlight coffeescript"><code>  <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
     <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">expectGET</span><span class="p">(</span><span class="s">"/browse/p.json"</span><span class="p">).</span><span class="na">respond</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">angular</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="nx">mockRecommendations</span><span class="p">))</span>
</code></pre>

<h5 id="step-7">Step 7.</h5>
<p>You then have to have an aftereacth that you didn't make more HTTP calls than expected. And that the HTTP requests resolve as expected.</p>

<pre class="highlight coffeescript"><code>  <span class="nx">afterEach</span> <span class="o">-&gt;</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingExpectation</span><span class="p">()</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingRequest</span><span class="p">()</span>
</code></pre>

<h5 id="step-8">Step 8.</h5>
<p>The below .fetch() method is my custom code. But after you make that call, you need to flush() which connects the fetch() call with the HTTP call that the <code>fetch()</code> makes.</p>

<pre class="highlight coffeescript"><code>  <span class="nx">describe</span> <span class="s">"Model: recommendationsModel"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">describe</span> <span class="s">"fetch()"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">it</span> <span class="s">"makes a GET request for recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">recommendations</span><span class="p">.</span><span class="na">fetch</span><span class="p">()</span>
        <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
</code></pre>

<h4 id="testing-a-directive">Testing a directive</h4>
<p>A directive will be added to the html so you need to create a before each to add some html the page;</p>

<h5 id="step-9">Step 9.</h5>
<p>Use Jquery to add some HTML to the page</p>

<pre class="highlight coffeescript"><code>  <span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">append</span><span class="p">(</span><span class="s">"
        &lt;div id='wrapper'&gt;
          &lt;p id='foo'&gt;remove me.&lt;/p&gt;
        &lt;/div&gt;
        "</span><span class="p">)</span>

    <span class="nx">afterEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">"#wrapper"</span><span class="p">).</span><span class="na">remove</span><span class="p">()</span>
</code></pre>

<h5 id="step-10">Step 10.</h5>
<p>Notice we are using <code>$compile</code> this service will convert the template and expressions into html. </p>

<pre class="highlight coffeescript"><code>    <span class="nx">it</span> <span class="s">"returns personalized recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="s">"
        &lt;recommendations selector='#foo'&gt;
          &lt;div ng-repeat='deal in deals'&gt;{{ deal.title }}&lt;/div&gt;
        &lt;/recommendations&gt;
      "</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="na">$apply</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Go-karting'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Sushi'</span>
</code></pre>

<h5 id="step-11">Step 11.</h5>
<p>Here, we use <code>$compile</code> to convert our directive into html.
Then, <code>$digest</code> attacheses it to the root scope. YOu have to do this.
~~~coffeescript
    it 'replaces an a existing element identified by selector attribute', -&gt;
      $compile("<recommendations selector="#foo"></recommendations>")($scope)
      $rootScope.$digest()
      $httpBackend.flush()
      expect($(document.body).html()).not.toContain 'remove me.'
~~~</p>

<h3 id="code-without-comments">Code without comments</h3>

<pre class="highlight coffeescript"><code><span class="c1">#= require libraries/angular
#= require plugins/recommendations
#= require helpers/specHelper
#= require helpers/angular_mocks
#= require mocks/recommendations_mocks
</span>
<span class="nx">describe</span> <span class="s">"Recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nx">$injector</span>           <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">recommendations</span>     <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$compile</span>            <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$scope</span>              <span class="o">=</span> <span class="no">undefined</span>
  <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="no">undefined</span>

  <span class="nx">beforeEach</span> <span class="nx">module</span><span class="p">(</span><span class="s">"RecommendationMocks"</span><span class="p">,</span> <span class="s">"app.recommendations"</span><span class="p">)</span>

  <span class="nx">beforeEach</span> <span class="nx">inject</span> <span class="p">(</span><span class="nx">_$injector_</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">$injector</span>           <span class="o">=</span> <span class="nx">_$injector_</span>
    <span class="nx">$compile</span>            <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$compile'</span><span class="p">)</span>
    <span class="nx">$rootScope</span>          <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$rootScope'</span><span class="p">)</span>
    <span class="nx">$scope</span>              <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$new</span><span class="p">()</span>
    <span class="nx">recommendations</span>     <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'recommendationsModel'</span><span class="p">)</span>
    <span class="nx">mockRecommendations</span> <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"mockRecommendations"</span><span class="p">)</span>
    <span class="nx">$httpBackend</span>        <span class="o">=</span> <span class="nx">$injector</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">'$httpBackend'</span><span class="p">)</span>

  <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
     <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">expectGET</span><span class="p">(</span><span class="s">"/browse/p.json"</span><span class="p">).</span><span class="na">respond</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">angular</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="nx">mockRecommendations</span><span class="p">))</span>

  <span class="nx">afterEach</span> <span class="o">-&gt;</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingExpectation</span><span class="p">()</span>
    <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">verifyNoOutstandingRequest</span><span class="p">()</span>

  <span class="nx">describe</span> <span class="s">"Model: recommendationsModel"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">describe</span> <span class="s">"fetch()"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">it</span> <span class="s">"makes a GET request for recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">recommendations</span><span class="p">.</span><span class="na">fetch</span><span class="p">()</span>
        <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>

  <span class="nx">describe</span> <span class="s">"Directive: recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">beforeEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">append</span><span class="p">(</span><span class="s">"
        &lt;div id='wrapper'&gt;
          &lt;p id='foo'&gt;remove me.&lt;/p&gt;
        &lt;/div&gt;
        "</span><span class="p">)</span>

    <span class="nx">afterEach</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">"#wrapper"</span><span class="p">).</span><span class="na">remove</span><span class="p">()</span>

    <span class="nx">it</span> <span class="s">"returns personalized recommendations"</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">element</span> <span class="o">=</span> <span class="nx">$compile</span><span class="p">(</span><span class="s">"
        &lt;recommendations selector='#foo'&gt;
          &lt;div ng-repeat='deal in deals'&gt;{{ deal.title }}&lt;/div&gt;
        &lt;/recommendations&gt;
      "</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="na">$apply</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Go-karting'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="na">html</span><span class="p">()).</span><span class="na">toContain</span> <span class="s">'Sushi'</span>

    <span class="nx">it</span> <span class="s">'replaces an a existing element identified by selector attribute'</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">$compile</span><span class="p">(</span><span class="s">"&lt;recommendations selector='#foo'&gt;&lt;/recommendations&gt;"</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">)</span>
      <span class="nx">$rootScope</span><span class="p">.</span><span class="na">$digest</span><span class="p">()</span>
      <span class="nx">$httpBackend</span><span class="p">.</span><span class="na">flush</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="na">body</span><span class="p">).</span><span class="na">html</span><span class="p">()).</span><span class="na">not</span><span class="p">.</span><span class="na">toContain</span> <span class="s">'remove me.'</span>
</code></pre>
</article></div></body><footer class="footer"><div class="footer-logo"></div><div class="footer-links"><ul><li><h3>Dave Woodall</h3></li><li><a href="/blog/about">about</a></li></ul><ul><li><h3>Pages</h3></li><li><a class="" href="/">new</a></li><li><a class="" href="/gifs/">gifs</a></li><li><a class="" href="/pictures/">pictures</a></li><li><a class="" href="/jots/">jots</a></li><li><a class="" href="/blog/">blog</a></li><li><a class="" href="/shortcuts/">shortcuts</a></li><li><a class="" href="/notes/">notes</a></li><li><a class="" href="/reading/">reading</a></li><li><a class="" href="/links/">links</a></li></ul><ul><li><h3>Social</h3></li><li><a target="_blank" href="http://www.github.com/woodall"><div class="fa fa-github"></div> <span>github</span></a></li><li><a target="_blank" href="http://www.dribbble.com/wwwoodall"><div class="fa fa-dribbble"></div> <span>dribbble</span></a></li><li><a target="_blank" href="http://www.twitter.com/wwwoodall"><div class="fa fa-twitter"></div> <span>twitter</span></a></li></ul></div><hr /><p>Designed & Built by Dave using <a target="_blank" href="http://www.middlemanapp.com">middleman</a> & thoughtbot <a target="_blank" href="http://thoughtbot.com/open-source">front-end</a>. </p></footer><script src="../scripts/nav_overlay-747321c6.js"></script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-52536027-1', 'auto');
ga('send', 'pageview');</script></html>